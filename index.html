<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<script src="resources/library/crafty.js"></script>
	<script type="text/javascript">
	//testeronivar 
	window.onload = function() {
		Crafty.init();
		Crafty.pixelart(true);
		Crafty.sprite(32,"resources/images/sprite.png", {
			face_forward: [0,0],
			face_back: [1,0],
			face_right: [0,1],
			face_left: [1,1],
			face_up: [0,2],
			face_down: [1,2],
			impulse: [0,3],
			repeating: [1,3],
			chain: [2,3],
			select: [3,3],
			empty: [1,-1]
		});
		iso = Crafty.isometric.size(32);
		var z=0;
		// for(var i = 20; i >= 0; i--) {
		// 	for(var y = 0; y < 20; y++) {
		// 		var which = Crafty.math.randomInt(0,1);
		// 		var tile = Crafty.e("2D, Canvas, "+ (!which ? "impulse" : "repeating") +", Mouse")
		// 		.attr('z',i+1 * y+1)
		// 	    .areaMap(16,0,0,8,0,24,16,32,32,24,32,8)
		// 	    .bind("Click", function(e) {
		// 		//destroy on right click
		//         //right click seems not work in Mac OS
		//         //delete it
		//         	console.log(e.button);
		// 			/*if(e.button === 2)*/ this.destroy();
		// 		}).bind("MouseOver", function() {
		// 			if(this.has("impulse")) {
		// 				this.attach(selected);
		// 			} else {
		// 				this.detach(selected);
		// 			}
		// 		}).bind("MouseOut", function() {
		// 			if(this.has("impulse")) {
		// 				this.detach(selected);
		// 			} else {
		// 				this.attach(selected);
		// 			}
		// 		});
		// 		iso.place(i,y,0, tile);
		// 	}
		// }
		//var selected = Crafty.e("2D","Canvas", "select");


		// var tile = Crafty.e("2D", "Canvas", "Mouse", "impulse").attr('z',0)		.areaMap(16,0,0,8,0,24,16,32,32,24,32,8)
		// .bind("Click",function(e){
		// 	console.log(e.button);
		// 	this.destroy();
		// }).bind("MouseOver",function(e){
		// 	this.attach(Crafty.e("2D","Canvas", "select").attr('z',0));
		// 	console.log(tile._children);
		// }).bind("MouseOut",function(e){
		// 	this._children[1].destroy();
		// console.log(tile._children);
		// });
		// var selected = [null]
		// for(var i=0;i<4;i++){
		// 	var drawselect=false;
		// 	var tile2 = Crafty.e("2D", "Canvas", "Mouse", "impulse").attr('z',1)
		// 	.areaMap(16,0,0,8,0,24,16,32,32,24,32,8)
		// 	.bind("Click",function(e){
		// 		console.log(e.button);
		// 		this.destroy();
		// 	}).bind("MouseOver",function(e){
		// 		drawselect=true;
		// 		if(drawselect==true){
		// 			this.attach(Crafty.e("2D", "Canvas", "select").attr('z',1))''
		// 			iso.place(i,3,0,this.child);
		// 		}
		// 	}).bind("MouseOut",function(e){
		// 		selected[i].destroy();
		// 		drawselect=false;
		// 	});
		// 	// iso.place(0,0,0,tile);
		// 	iso.place(i,3,0,tile2);
		// 	// console.log(tile2._children[0]);
		// }
		for(var x=0;x<16;x++){
			for(var y=0;y<32;y++){
				for(var z=0;z<3;z++){
					var tile = Crafty.e("2D", "Canvas", "Mouse", "impulse")
					.attr('z',y+z*32)//
					.areaMap(16,0, 0,8, 0,24, 16,32, 32,24, 32,8) //series of points defining area
					.bind("drawFace",function(dir){
						drawWith(this._x,this._y,this._z,iso,this,dir);
						drawWith(this._x,this._y,this._z,iso,this,"empty");
					})
					.bind("Click",function(e){
						console.log(e.button);
						this.destroy();
					}).bind("MouseOver",function(e){
						this._children[2].sprite("select");
					}).bind("MouseOut",function(e){
						this._children[2].sprite("empty");
					});
					iso.place(x,y,z*2,tile);
					if(z==0)tile.sprite("chain").trigger("drawFace","face_up");
					if(z==1)tile.trigger("drawFace","face_down");
					if(z==2)tile.sprite("repeating").trigger("drawFace","face_left");
				}
			}
		}
		Crafty.addEvent(this, Crafty.stage.elem, "mousedown", function(e) {
			if(e.button > 1) return;
			var base = {x: e.clientX, y: e.clientY};

			function scroll(e) {
				var dx = base.x - e.clientX,
					dy = base.y - e.clientY;
					base = {x: e.clientX, y: e.clientY};
				Crafty.viewport.x -= dx;
				Crafty.viewport.y -= dy;
			};

			Crafty.addEvent(this, Crafty.stage.elem, "mousemove", scroll);
			Crafty.addEvent(this, Crafty.stage.elem, "mouseup", function() {
				Crafty.removeEvent(this, Crafty.stage.elem, "mousemove", scroll);
			});
		});
	};
	function drawWith(x,y,z,iso,parent,sprite){
		px = iso.px2pos(x,y);
		child=parent._children.length;
		parent.attach(Crafty.e("2D","Canvas",sprite).attr('z',z));
		iso.place(px.x,px.y,0,parent._children[child]);
	}
	// function placeAt(x,y,z,obj,iso){
	// 	px = iso.px2pos(x,y);
	// 	iso.place(px.x,px.y,z,obj);
	// }
	</script>
	<title>Testeroni</title>
</head>
<body>

</body>
</html>